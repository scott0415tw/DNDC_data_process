rm(list = ls())

# 安裝必要套件（若尚未安裝）
# install.packages(c("sf", "ggplot2", "dplyr"))

library(sf)
library(ggplot2)
library(dplyr)

# ====== 1. 讀入你的經緯度資料 ======
df <- read.table(header = TRUE, text = "
LON LAT
121.27661	25.11528
121.297	25.09647
121.29718	25.1151
121.29739	25.13372
121.31534	24.89143
121.31552	24.91006
121.31573	24.92869
121.31592	24.94732
121.31613	24.96593
121.31757	25.09629
121.31775	25.11491
121.31796	25.13354
121.33524	24.83537
121.33545	24.854
121.33566	24.87262
121.33588	24.89125
121.33606	24.90987
121.33627	24.9285
121.33649	24.94713
121.33667	24.96574
121.33688	24.98438
121.33792	25.0775
121.33813	25.09612
121.33832	25.11474
121.33853	25.13338
121.35577	24.83519
121.35596	24.85382
121.3562	24.87244
121.35638	24.89106
121.3566	24.90969
121.35681	24.92831
121.35703	24.94694
121.35724	24.96556
121.35742	24.98418
121.35828	25.05867
121.35846	25.07729
121.35867	25.09594
121.35889	25.11455
121.3591	25.13318
121.37628	24.83501
121.3765	24.85362
121.37671	24.87226
121.37692	24.89087
121.37714	24.90951
121.37735	24.92812
121.37756	24.94673
121.37778	24.96536
121.37799	24.98398
121.37817	25.00261
121.37881	25.05848
121.37903	25.07712
121.37924	25.09574
121.37946	25.11437
121.37967	25.13299
121.37988	25.15162
121.3801	25.17023
121.39682	24.83481
121.39703	24.85343
121.39725	24.87206
121.39746	24.89068
121.39767	24.90931
121.39789	24.92793
121.3981	24.94656
121.39832	24.96518
121.39853	24.9838
121.39874	25.0024
121.39896	25.02105
121.39917	25.03967
121.39938	25.05828
121.3996	25.07692
121.39981	25.09553
121.40002	25.11417
121.40024	25.13279
121.40045	25.1514
121.40067	25.17002
121.40088	25.18867
121.41647	24.76014
121.41711	24.81598
121.41733	24.83462
121.41754	24.85323
121.41776	24.87186
121.41797	24.89047
121.41821	24.9091
121.41843	24.92773
121.41864	24.94636
121.41885	24.96499
121.41907	24.9836
121.41928	25.00222
121.41949	25.02085
121.41974	25.03947
121.41992	25.0581
121.42017	25.07673
121.42038	25.09536
121.42059	25.11399
121.42081	25.13261
121.42102	25.1512
121.42126	25.16984
121.42148	25.18846
121.42169	25.20709
121.43652	24.72268
121.43677	24.74131
121.43698	24.75993
121.43719	24.77855
121.43741	24.79716
121.43762	24.81579
121.43787	24.83441
121.43808	24.85303
121.43829	24.87165
121.43851	24.89028
121.43872	24.90891
121.43896	24.92753
121.43918	24.94615
121.43939	24.96479
121.43961	24.9834
121.43982	25.00202
121.44006	25.02066
121.44028	25.03927
121.44049	25.0579
121.44073	25.07653
121.44095	25.09516
121.44116	25.11379
121.44138	25.13241
121.44159	25.151
121.44183	25.16964
121.44205	25.18827
121.44226	25.20688
121.4425	25.22552
121.44272	25.24414
121.45682	24.70386
121.45703	24.72249
121.45728	24.7411
121.45749	24.75972
121.4577	24.77836
121.45792	24.79697
121.45816	24.81557
121.45837	24.83421
121.45859	24.85283
121.4588	24.87146
121.45905	24.89009
121.45926	24.9087
121.45947	24.92734
121.45972	24.94596
121.45993	24.96455
121.46014	24.98321
121.46039	25.00181
121.4606	25.02044
121.46082	25.03906
121.46106	25.05769
121.46127	25.07632
121.46219	25.15082
121.4624	25.16945
121.46265	25.18806
121.46286	25.20669
121.46307	25.22532
121.46332	25.24394
121.46353	25.26256
121.47687	24.66641
121.47708	24.68503
121.47729	24.70366
121.47754	24.72227
121.47775	24.7409
121.478	24.75953
121.47821	24.77815
121.47845	24.79676
121.47867	24.81538
121.47888	24.83401
121.47913	24.85263
121.47934	24.87125
121.47958	24.88987
121.4798	24.9085
121.48004	24.92712
121.48026	24.94576
121.48047	24.96435
121.48071	24.98299
121.48163	25.05749
121.48184	25.07612
121.48322	25.18787
121.48343	25.20649
121.48367	25.22511
121.48389	25.24373
121.48413	25.26234
121.48434	25.28098
121.49734	24.66619
121.49759	24.6848
121.4978	24.70346
121.49805	24.72206
121.49826	24.74069
121.4985	24.75931
121.49872	24.77792
121.49896	24.79655
121.49918	24.81517
121.49942	24.8338
121.49963	24.85242
121.49988	24.87104
121.50012	24.88967
121.50034	24.90831
121.50055	24.92693
121.50079	24.94555
121.50104	24.96416
121.50125	24.98279
121.50378	25.18765
121.50403	25.20626
121.50424	25.22489
121.50449	25.24351
121.5047	25.26215
121.50494	25.28077
121.50519	25.29938
121.51807	24.68461
121.51831	24.70325
121.51855	24.72186
121.51877	24.74049
121.51901	24.7591
121.51923	24.77772
121.51947	24.79633
121.51971	24.81495
121.51993	24.83359
121.52017	24.85221
121.52039	24.87084
121.52063	24.88946
121.52087	24.90809
121.52112	24.92671
121.52133	24.94533
121.52158	24.96396
121.5246	25.20606
121.52484	25.2247
121.52509	25.24332
121.5253	25.26193
121.52554	25.28057
121.52579	25.29917
121.53857	24.68441
121.53882	24.70302
121.53903	24.72165
121.53928	24.74027
121.53952	24.75889
121.53973	24.77751
121.53998	24.79612
121.54022	24.81474
121.54047	24.83337
121.54071	24.85199
121.54092	24.87062
121.54117	24.88925
121.54138	24.90786
121.54163	24.92649
121.54187	24.94512
121.54211	24.96373
121.54541	25.22447
121.54565	25.24309
121.5459	25.26171
121.54614	25.28035
121.54639	25.29896
121.5593	24.70281
121.55954	24.72144
121.55978	24.74007
121.56003	24.75866
121.56024	24.77729
121.56049	24.79591
121.56073	24.81454
121.56097	24.83316
121.56122	24.85179
121.56146	24.87041
121.56171	24.88903
121.56195	24.90767
121.56216	24.92629
121.56241	24.9449
121.56601	25.22426
121.56625	25.24288
121.5665	25.26151
121.56674	25.28013
121.56699	25.29875
121.5798	24.7026
121.58005	24.72121
121.58029	24.73983
121.58054	24.75844
121.58078	24.77707
121.58099	24.79568
121.58124	24.8143
121.58148	24.83293
121.58173	24.85155
121.58197	24.87019
121.58221	24.88881
121.58246	24.90743
121.5827	24.92605
121.58295	24.94468
121.58636	25.20541
121.58661	25.22404
121.58685	25.24267
121.5871	25.26127
121.58734	25.27989
121.58759	25.29852
121.60056	24.72098
121.6008	24.73962
121.60104	24.75822
121.60129	24.77685
121.60153	24.79547
121.60178	24.8141
121.60202	24.83273
121.60226	24.85136
121.60251	24.86997
121.60275	24.8886
121.603	24.90723
121.60324	24.92583
121.60349	24.94447
121.60645	25.16794
121.60669	25.18658
121.60693	25.20521
121.60718	25.22383
121.60742	25.24244
121.60767	25.26107
121.60791	25.27969
121.60818	25.29831
121.62204	24.79525
121.62228	24.81387
121.62253	24.83249
121.6228	24.85112
121.62305	24.86975
121.62329	24.88838
121.62354	24.907
121.62378	24.92559
121.62402	24.94424
121.62479	25.00011
121.62653	25.13047
121.62677	25.1491
121.62701	25.1677
121.62726	25.18636
121.62753	25.20496
121.62778	25.22361
121.62802	25.24222
121.62827	25.26083
121.62854	25.27945
121.64282	24.81364
121.64307	24.83227
121.64331	24.8509
121.64355	24.86953
121.6438	24.88815
121.64407	24.90676
121.64432	24.92539
121.64456	24.94402
121.64484	24.96265
121.64508	24.98126
121.64532	24.99989
121.64609	25.05578
121.64633	25.07438
121.64661	25.09298
121.64685	25.11161
121.64709	25.13025
121.64734	25.14887
121.64758	25.16748
121.64786	25.18611
121.6481	25.20474
121.64838	25.22337
121.64862	25.24199
121.66333	24.81342
121.66357	24.83204
121.66382	24.85068
121.66409	24.86929
121.66434	24.88791
121.66461	24.90654
121.66486	24.92516
121.6651	24.94377
121.66534	24.9624
121.66562	24.98103
121.66586	24.99965
121.66663	25.05552
121.6669	25.07412
121.66714	25.09274
121.66791	25.14863
121.66818	25.16727
121.66843	25.18589
121.6687	25.20451
121.68384	24.81318
121.68408	24.8318
121.68436	24.85044
121.68463	24.86905
121.68488	24.88769
121.68512	24.90629
121.68539	24.92492
121.68564	24.94355
121.68591	24.96217
121.68616	24.98081
121.68643	24.99941
121.68668	25.01803
121.68695	25.03666
121.68719	25.05529
121.68744	25.0739
121.68771	25.09253
121.68848	25.1484
121.68875	25.16703
121.68903	25.18565
121.68927	25.20427
121.68951	25.2229
121.70462	24.83158
121.7049	24.8502
121.70514	24.86882
121.70538	24.88743
121.70566	24.90606
121.70593	24.92469
121.70618	24.94331
121.70645	24.96193
121.70673	24.98056
121.70697	24.99918
121.70721	25.0178
121.70749	25.03643
121.70776	25.05505
121.70801	25.07367
121.70932	25.16678
121.70959	25.18542
121.70984	25.20403
121.71011	25.22267
121.7254	24.84996
121.72568	24.86859
121.72592	24.88721
121.7262	24.90583
121.72647	24.92447
121.72672	24.94308
121.72699	24.96169
121.72726	24.98033
121.72751	24.99894
121.72778	25.01756
121.72806	25.0362
121.72833	25.05479
121.74591	24.84973
121.74619	24.86836
121.74646	24.88694
121.74673	24.90558
121.74701	24.9242
121.74725	24.94283
121.74753	24.96146
121.7478	24.98007
121.74808	24.9987
121.74835	25.01732
121.7486	25.03595
121.74887	25.05457
121.74939	25.09181
121.74969	25.11045
121.76645	24.84949
121.76672	24.8681
121.767	24.8867
121.76727	24.90535
121.76752	24.92396
121.76779	24.94258
121.76807	24.96121
121.76834	24.97983
121.76862	24.99846
121.76889	25.01709
121.76917	25.0357
121.76944	25.05432
121.76971	25.07294
121.76996	25.09157
121.77023	25.1102
121.77051	25.12881
121.78723	24.86785
121.78754	24.88647
121.78778	24.90509
121.78806	24.92372
121.78833	24.94234
121.7886	24.96097
121.78888	24.9796
121.78915	24.99822
121.78943	25.01685
121.7897	25.03544
121.78998	25.05407
121.79025	25.0727
121.79053	25.09133
121.7908	25.10994
121.79108	25.12856
121.80832	24.90484
121.80859	24.92346
121.80887	24.94209
121.80914	24.9607
121.80945	24.97934
121.80969	24.99797
121.81	25.01659
121.81027	25.03521
121.81055	25.05382
121.81082	25.07244
121.8111	25.09109
121.81137	25.1097
121.81165	25.12833
121.82886	24.90459
121.82913	24.9232
121.82941	24.94183
121.82971	24.96045
121.82999	24.97909
121.83026	24.99771
121.83054	25.01633
121.83081	25.03495
121.83112	25.05358
121.83139	25.0722
121.83167	25.09082
121.83194	25.10946
121.83221	25.12807
121.8494	24.90432
121.84967	24.92295
121.84995	24.94158
121.85025	24.96021
121.85052	24.97882
121.8508	24.99746
121.85107	25.01608
121.85138	25.03469
121.85165	25.05333
121.85193	25.07193
121.85223	25.09056
121.85251	25.10919
121.85278	25.12782
121.87079	24.95995
121.87106	24.97857
121.87134	24.9972
121.87164	25.01582
121.87192	25.03443
121.87222	25.05305
121.8725	25.07169
121.8728	25.09031
121.87308	25.10894
121.87335	25.12756
121.89133	24.95968
121.8916	24.97831
121.89191	24.99694
121.89218	25.01554
121.89249	25.03417
121.89276	25.05281
121.89307	25.07143
121.89337	25.09006
121.89365	25.10868
121.89392	25.12731
121.91217	24.97805
121.91245	24.99667
121.91275	25.0153
121.91302	25.03392
121.91333	25.05255
121.91364	25.07117
121.91391	25.08979
121.91422	25.10842
121.91449	25.12704
121.93271	24.97779
121.93298	24.9964
121.93329	25.015
121.93359	25.03364
121.9339	25.05227
121.93417	25.07089
121.95325	24.9775
121.95355	24.99613
121.95386	25.01476
121.97379	24.97725
121.97409	24.99587
121.9744	25.01448
121.9747	25.0331
121.99463	24.99558
121.99493	25.01421
122.0155	25.01392"
)

# ====== 2. 轉成 sf 空間物件（CRS = WGS84, EPSG:4326） ======
pts_wgs84 <- st_as_sf(df, coords = c("LON", "LAT"), crs = 4326)

# ====== 3. 選擇 UTM 投影（依平均經度自動選 zone） ======
mean_lon <- mean(df$LON)
zone <- floor((mean_lon + 180) / 6) + 1
utm_epsg <- 32600 + zone  # 北半球用 326xx
message("使用 UTM Zone: ", zone, " (EPSG:", utm_epsg, ")")

pts_utm <- st_transform(pts_wgs84, crs = utm_epsg)

# ====== 4. 建立網格（例如 2 公里 × 2 公里） ======
cellsize_m <- 2000  # 你可改成 500、1000、5000 公尺等
bbox <- st_bbox(pts_utm)
margin <- cellsize_m
bbox_expanded <- bbox + c(-margin, -margin, margin, margin)

grid <- st_make_grid(
  st_as_sfc(bbox_expanded),
  cellsize = cellsize_m,
  square = TRUE
)
grid_sf <- st_sf(grid_id = seq_along(grid), geometry = grid)

# ====== 5. 每個點屬於哪個格子 ======
pts_joined <- st_join(pts_utm, grid_sf, join = st_within)

# ====== 6. 計算每個格子的行列座標（row/col） ======
grid_centroids <- st_centroid(grid_sf)
cent_coords <- st_coordinates(grid_centroids)
minx <- min(cent_coords[,1])
miny <- min(cent_coords[,2])

grid_sf <- grid_sf %>%
  mutate(
    cx = cent_coords[,1],
    cy = cent_coords[,2],
    col = floor((cx - minx) / cellsize_m) + 1,
    row = floor((cy - miny) / cellsize_m) + 1
  )

pts_joined <- pts_joined %>%
  left_join(st_drop_geometry(grid_sf) %>% select(grid_id, col, row), by = "grid_id")


# ====== 7. 顯示結果 ======
print(pts_joined)


# ====== 找最近點 ======
new_point <- data.frame(lon = 121.5252, lat = 24.9592)
new_sf <- st_as_sf(new_point, coords = c("lon", "lat"), crs = 4326)


nearest_index <- st_nearest_feature(new_sf, pts_wgs84)
nearest_point <- pts_wgs84[nearest_index, ]

print(nearest_point)

# ====== 8. 繪圖：網格 + 點 ======
ggplot() +
  geom_sf(data = grid_sf, fill = NA, color = "grey70") +
  geom_sf(data = pts_utm, color = "red", size = 2)+
  geom_sf(data = new_sf, color = 'blue', size = 1)
# +geom_sf(data = pts_wgs84[nearest_index, ], color = "green", size = 2)

# # geom_sf_text(data = grid_sf, aes(label = grid_id), size = 3, color = "grey40") +
# labs(
#   title = paste0("UTM Grid Map (cell = ", cellsize_m, " m)"),
#   subtitle = paste0("Zone ", zone, " (EPSG:", utm_epsg, ")")
# ) +
# theme_minimal()

#=====包圍點 =====



